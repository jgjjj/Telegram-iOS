name: "Build unsigned Telegram ipa"

on:
  workflow_dispatch: {}

jobs:
  build_unsigned:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set active Xcode path
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer

      - name: Create canonical source directory
        run: |
          set -x
          sudo mkdir -p /Users/Shared
          cp -R $GITHUB_WORKSPACE /Users/Shared/
          mv /Users/Shared/$(basename $GITHUB_WORKSPACE) /Users/Shared/telegram-ios

      - name: Generate Xcode project
        run: |
          set -x

          # source code paths are included in the final binary, so we need to make them stable across builds
          SOURCE_DIR=/Users/Shared/telegram-ios

          # use canonical bazel root
          BAZEL_USER_ROOT="/private/var/tmp/_bazel_containerhost"

          cd $SOURCE_DIR

          BUILD_NUMBER_OFFSET="$(cat build_number_offset)"

          export APP_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["app"]);')
          export COMMIT_COUNT=$(git rev-list --count HEAD)
          export COMMIT_COUNT="$(($COMMIT_COUNT+$BUILD_NUMBER_OFFSET))"
          export BUILD_NUMBER="$COMMIT_COUNT"
          echo "BUILD_NUMBER=$(echo $BUILD_NUMBER)" >> $GITHUB_ENV
          echo "APP_VERSION=$(echo $APP_VERSION)" >> $GITHUB_ENV

          python3 -u build-system/Make/Make.py \
            --bazelUserRoot="$BAZEL_USER_ROOT" \
            generateProject \
            --configurationPath="build-system/template_minimal_development_configuration.json" \
            --xcodeManagedCodesigning \
            --disableProvisioningProfiles \
            --buildNumber="$BUILD_NUMBER"

      - name: Build archive without code signing
        run: |
          set -e
          SOURCE_DIR=/Users/Shared/telegram-ios
          cd $SOURCE_DIR
          xcodebuild \
            -project Telegram/Telegram.xcodeproj \
            -scheme Telegram \
            -sdk iphoneos \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$RUNNER_TEMP/Telegram.xcarchive" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            clean archive

      - name: Create unsigned IPA
        run: |
          set -e
          ARCHIVE_APPS_DIR="$RUNNER_TEMP/Telegram.xcarchive/Products/Applications"
          echo "Contents of $ARCHIVE_APPS_DIR:"
          ls -la "$ARCHIVE_APPS_DIR"

          APP_NAME=$(ls "$ARCHIVE_APPS_DIR" | grep ".app$" | head -n 1)
          if [ -z "$APP_NAME" ]; then
            echo "No .app found in $ARCHIVE_APPS_DIR"
            exit 1
          fi

          APP_PATH="$ARCHIVE_APPS_DIR/$APP_NAME"
          echo "Using app: $APP_PATH"

          PAYLOAD_DIR="$RUNNER_TEMP/Payload"
          mkdir -p "$PAYLOAD_DIR"
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"
          cd "$RUNNER_TEMP"
          zip -r "Telegram-unsigned.ipa" Payload

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: telegram-unsigned-ipa
          path: ${{ runner.temp }}/Telegram-unsigned.ipa
          retention-days: 7

